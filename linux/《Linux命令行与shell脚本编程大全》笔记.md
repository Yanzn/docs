# 《Linux命令行与shell脚本编程大全》笔记

Linux的组成：
 - Linux内核
 - GNU工具
 - 图形化桌面环境
 - 应用软件 

---

## Linux 内核  
内核功能：
- 系统内存管理
- 软件程序管理
- 硬件设备管理
- 文件系统管理  

**系统内存管理**    
通过硬盘上的存储空间实现虚拟内存，这块空间称为交换空间 （swap space）。  
内核管理虚拟内存和物理内存。  
内核把一段时间未访问的内存单元数据复制到交换空间（换出 swapping out）。  
访问已被换出到虚拟内存的内容时，再将其复制到物理内存。
物理内存与虚拟内存的换入换出过程会花费时间，拖慢运行中的进程。  
内核在虚拟内存和物理内存之间交换内容，使得系统拥有比物理内存更多的可用内存。    

**软件程序管理**   
内核创建第一个进程（init进程）来启动其他所有进程。  
内核启动时将init进程加载到虚拟内存。  
内核启动其他进程时，会在虚拟内存中给要启动的进程分配一块专有空间，来存储该进程用到的数据和代码。  
init采用了运行级，基于控制台的程序运行级是3，图形桌面环境的系统运行级是5。  

**硬件设备管理**  
Linux系统将硬件设备当成特殊的文件，称为设备文件。

**文件系统管理**  
Linux通过支持不同类型的文件系统从硬盘读写数据。  
内核采用虚拟文件系统（Virtual File System，VFS）作为和每个文件系统交互的标准接口。  

## GNU工具
- GNU coreutils
  - 操作文本的工具
  - 操作文件的工具
  - 管理进程的工具
- shell

---

## shell

**启动shell**
用户登录，会根据 `/etc/passwd` 文件加载配置，启动对应的`shell`，如下配置了`/bin/bash`，登陆后会启动 `bash shell`。  
``yzn:x:1000:1000:yzn,,,:/home/yzn:/bin/bash``    

`man` 命令访问程序或命令的说明。  

---

## Linux文件系统
Linux将所有挂载盘的文件都纳入到同一个虚拟目录中。  
Linux PC上安装的第一块硬盘称为根驱动器。  
根驱动器包含虚拟目录的核心，其他目录都是从这里开始构建的。  
Linux会在根驱动器创建特殊目录作为挂载点，即额外存储设备的目录。  

常见的虚拟目录名：
| 目录      | 用途 |
| ----------- | ----------- |
| `/ `        |虚拟目录的根目录|
| `/bin`      |二进制目录，存放很多用户级的GNU工具|
| `/sbin`     |系统二进制目录，存放管理员级GNU工具|
| `/boot`     |启动目录，存放启动文件|
| `/etc`      |系统配置文件目录|
| `/home`     |主目录，Linux在这里创建用户目录|
| `/usr`      |用户二进制目录，用户级的GNU工具和数据文件|
| `/tmp`      |临时文件夹|
| `/opt`      |可选目录，常用语存放第三方软件包和数据文件|
| `/mnt`      |挂载目录|
| `/lib`      |库文件目录|
| `/dev`      |设备目录，存放设备节点|

**遍历目录**  
- 单点符 `.` ，表示当前目录
- 双点符`..` ，表示当前目录的上级目录
- 波浪符 `~` ，表示用户目录

**`ls` 命令**

- 输出的列表按照名称正序排列
- `-F` 参数用于区分目录和文件
- `-a` 参数用于显示隐藏文件
- `-R` 参数用于递归显示所有子目录的文件
- 命令参数可以合并
- `-l` 参数产生长列表格式输出
- 过滤输出列表
|  |  |  |

**`cp ` 命令复制文件**  
基本用法：  
`cp source destination`  
- source是文件时，会在destination生成新文件
- destination 末尾最好加上`/`，末尾没有`/`且目录不存在，会创建destination目录
- `-i` 参数，询问是否覆盖已有文件
- `-R` 参数，递归复制整个目录的内容
  
**`mv` 命令移动或重命名  **  

**`rm` 命令**
- `-i` 参数，确认是否删除
- `-f` 参数，强制删除，忽略提示信息
- `-r` 参数，删除目录时递归删除所有子目录和文件
- `-rf`参数，删除目录及所有内容（危险）

**`mkdir` 命令创建目录**
- `-p` 参数用于一次创建多级目录
- `rmdir` 命令用于删除空目录(安全，目录不是空的时候会报错) 

---

### 查看文件内容

**`file` 命令查看文件类型**  

**`cat` 命令显示文本文件的所有内容**
- `-n` 参数，给所有行加行号 
- `-b` 参数，给有文本的行加行号
- 运行后无法控制，显示完所有内容才会停止  

**`more` 命令分页显示文本文件内容**
- 显示每页数据后停下来，空格键显示下一页，q键退出   

**`less` 命令**
- 比 `more` 命令功能丰富，支持上下键翻页  

**`tail` 命令查看部分文件**
- `-n` 参数，指定显示末尾行数  
- `-f` 参数，动态展示末尾行数，监控日志

## 监测程序  

**`ps` 命令显示当前时间点的程序信息**  
`ps -ef` 参数组合   

**`top` 命令动态显示程序信息**   
动态显示正在运行的程序信息、内存和cpu、系统负载等情况。  

**结束进程**  
进程之间通过Linux进程信号来通信。  
| 信号    | 名称 |    描述|
| ------ | ------ | ------ |
| 1 | HUP | 挂起 |
| 2 | INI | 中断 |
| 3 | QUIT | 结束运行 |
| 9 | KILL | 无条件终止 |
| 11 | SEGV | 段错误 |
| 15 | TERM | 尽可能终止 |
| 17 | STOP | 无条件停止运行，但不终止 |
| 18 | TSTP | 停止或暂停，但继续在后台运行 |
| 19 | CONT | 在STOP或TSTP之后恢复执行 |

向进程发信号的两个命令（默认都是发送 `TERM` 信号）
- `kill` 命令， 只能根据pid向进程发信号
- `killall`命令，支持进程名称发信号，也支持通配符  

## 监测磁盘空间

**`mount` 命令挂载磁盘或者移动媒体**  
**`umount` 命令卸载**  

**`df` 命令查看还有多少空闲磁盘空间**
- `-h` 参数，K/M/G代替字节

**`du` 命令判断某个目录下是否有超大文件**  
- `-h` 参数，K/M/G代替字节
- `-c` 参数，显示所有已列出文件总的大小

**`sort` 命令用来排序**  
- `-n` 参数，按照字符串排序
- `-r` 参数，倒叙

**`grep` 命令**  
- 格式： `grep [options] pattern [file]`
- `grep` 会在输入或者指定的文件中查找包含匹配指定模式的字符的行
- `-v` 参数，反向查找（不匹配的行）
- `-c` 参数，只输出匹配的行数
- `-e` 参数，可以指定多个匹配模式
- 支持正则匹配   

**`tar` 命令归档数据**  
- `-x` 参数，从tar文件中提取文件
- `-c` 参数，创建tar文件
- `-v` 参数，在处理时显示文件
- `-f` 参数，输出结果到文件  
- `-z` 参数，将输出重定向给`gzip`命令
- `-t` 参数，列出tar文件中的文件
  
```shell
# 压缩目录
$ tar -cvf test.tar /test /test2
# 列出tar文件中的内容，但不提取
$ tar -tf test.tar
# 解压tar文件
$ tar -xvf test.tar
# 解压 .tgz(gzip压缩过的tar文件) 格式的压缩包
$ tar -zxvf test.tgz
```

## 理解shell   

- 用户登录终端时，系统会启动一个默认的交互式shell。
启动哪一个取决于 `/etc/passwd` 文件中用户ID配置。一般这个shell都是`/bin/bash`。  

- 进程列表和协程`coproc`命令会产生子shell。 子shell可以嵌套子shell。创建子shell会创建新的运行环境，成本高。终端控制着子shell的I/O。

- 分号 `;` 分割的一组命令称为命令列表。括号围起来的命令列表称为进程列表。进程列表会生成子shell。  

- 后台模式：优点是终端不会控制子shell的I/O，可以使用子shell处理其他任务。  

- 协程：将命令置入后台模式执行。 用法就是 `coproc` 命令加要在子shell中执行的命令。`jobs` 命令可以查看后台运行中的用户进程。  

- 内建命令是不会产生子shell进程的命令，如`cd`, `pwd` 等。
执行外部命令时，会创建出一个子进程。这种操作被称为衍生（forking）。
`ps` 命令就是外部命令。
外部命令通常位于 `/bin`, `/usr/bin`, `/sbin`, `/usr/sbin`目录中。
可以使用`which`命令查看命令位置。
可以使用`type`命令查看某个命令是否是内建的。
内建命令与外部命令的区别在于前者不需要使用子进程来执行。  

- `history` 命令可以查看最近使用过的命令列表。
命令历史记录被保存在 `~/.bash_history` 文件中。
命令执行后被保存在内存中，shell退出时才会写入`~/.bash_history` 文件。
可以使用`history -a` 将内存中的命令记录强制写入文件。   

- `alias` 命令可以为命令创建别名，从而减少输入量。
`alias -p` 查看当前可用的别名。  
例如：`alias gst='git status'`。
只在当前shell进程有效，若要每次登录后都有效，可以写到对应shell的配置文件中，`bash` 的配置文件是`/etc/bashrc`。

---  

## 环境变量

- 环境变量存储在内存中。  
全局环境变量对于shell会话和所有生成的子shell都可见。    
子shell可以修改父shell设置的全局变量的值，但只在子shell内有效，父shell中该全局变量值不会改变。  
局部环境变量只对创建它们的shell可见， 对子shell不可见。    

- 系统环境变量都用大写字母，用户环境变量都用小写。
直接用等于号 `=` 给变量赋值， 值含有空格时要用引号。  

- 创建局部变量，使用 `export` 命令将该变量导出为全局变量。不导出的全局变量，子shell看不到。  
子shell无法使用 `export` 命令改变父shell中全局变量的值。  
`unset` 命令删除环境变量。  

- 使用环境变量时变量名前需要添加 `$` 符号，操作变量时不需要。  
子shell删除父shell的环境变量，只对子shell有效，不影响父shell中的变量值。  

- `PATH` 环境变量定义了用于进行命令和程序查找的目录。

- 登录Linux后，`bash shell`会作为登录shell启动。  
登录shell会从五个不同的启动文件里读取命令,设置环境变量：
  - /etc/profile
  - $HOME/.bash_prifile
  - $HOME/.bashrc
  - $HOME/.bash_login
  - $HOME/.profile 

- 加载过程：  
  `/etc/profile` 是主启动文件，先被加载。会按照以下顺序，运行第一个被找到文件，余下的被忽略：  
  > `$HOME/.bash_prifile`    
  `$HOME/.bash_login`   
  `$HOME/.profile` 。

  而`$HOME/.bashrc` 通常是由上面的文件引用加载的。  
  比如在 `$HOME/.bash_prifile` 中有代码会判断主目录是否存在`.bashrc`文件，存在则先执行该文件中的命令。

  `/etc/profile` 是主启动文件，但会随着系统升级而更新，不建议将自定义变量设置在该文件中。   

  **持久化环境变量的最好方法，是在`/etc/profile.d`目录下创建一个`.sh`结尾的文件（`/etc/profile` 会执行文件夹下的所有`.sh`文件），把所有新的或修改过的全局环境变量放在这个文件中**   

---  

## 文件权限  

`/etc/passwd` 文件存储着用户登录名与UID的值。

所有后台服务都有一个系统账户。  

`/etc/shadow` 文件存储用户名和密码，只有root用户可以访问。  

---

### 添加用户命令 `useradd`   

`useradd` 命令使用系统默认值或者参数指定来设置用户账户。默认值存储在 `/etc/default/useradd` 文件中，可以使用 `useradd -D` 命令查看。`useradd -D` 增加对应的参数可以修改默认值。

添加用户时可以指定HOME目录、添加分组、指定过期日期等。

---

### 删除用户命令 `userdel`  
`userdel` 命令只会删除 `/etc/passwd` 文件中的用户数据，不会删除系统中属于该用户的文件。

---

### 修改用户  
- `usermod` 命令可以修改大部分信息，如用户登录名、锁定用户、解除锁定等。  
- `passwd` 可以修改密码，`-e`参数强制用户下次登录修改密码。
- `chpaswd` 批量修改用户密码。

---

### 用户组   
linux组（group）允许多个用户对系统中的对象（文件、目录或设备）共享一组共用的权限。  

`/etc/group` 文件存储所有组信息。
  
- `groupadd` 命令创建组
- `groupmod` 命令修改组

--- 

### 文件权限
```shell
$ ls -l
total 3504
drwxr-xr-x    8 yanzhangning  staff   256B  2  2  2019 apache
-rw-r--r--@   1 yanzhangning  staff   210B  7 27  2017 bash_profile
```

`ls -l` 命令列出当前目录下的所有文件和文件夹   
其中第一列代表类型：
- `d` 代表文件夹
- `-` 代表文件
- `l` l 代表链接
- 其他的代表各种设备   

后面有三组三字符编码，每组定义了3中访问权限：
- `r` 可读
- `w` 可写 
- `e` 可执行  

三组权限对应对象的3个安全级别：
- 对象的属主
- 对象的属组
- 系统其他用户

---

### 默认文件权限

*Linux文件权限码*

| 权限 | 二进制值 | 八进制值 |
| :-----| ----: | :----: |
| --- | 000 | 0 |
| --x | 001 | 1 |
| -w- | 010 | 2 |
| -wx | 011 | 3 |
| r-- | 100 | 4 |
| r-x | 101 | 5 |
| rw- | 110 | 6 |
| rwx | 111 | 7 |

文件或目录被创建时会被赋予默认的权限值，这些默认的权限值通过`umask`命令查询和设置。  
```shell
$ umask
022
```

`umask` 值是八进制值。把`umask` 值从对象的全权限值减掉就是默认权限。文件的全权限是`666`（所有用户都有读写的权限），目录的全权限是`777`（所有用户都有读写和执行的权限）。所以`umask` 值是`022`时，文件全权限值`666`每一位减掉对应的`umask` 值得到文件默认权限`644`, 二进制为`110100100`, 即`rw-r--r--`。同理，文件夹默认权限是`755`, 二进制是`111101101`，即`rwxr-xr-x`。

---  

### 改变权限
`chmod` 命令改变文件和目录的安全性设置。  
格式：`chmod options mode file`  
`options` 使用 `-R` 可以递归到所有子文件和目录。  
`mode` 参数分八进制模式、符号模式两种。  
```

$ ls -l
total 3504
drwxr-xr-x    8 yanzhangning  staff   256B  2  2  2019 apache
```
如果要取消其他用户的执行权限，增加组的写权限，即改为`rwxrwxr--`，采用两种方式的区别：

**八进制模式**：
三组权限值按照二进制转换为八进制  
`rwxr-xr-x` 三组权限对应的二进制是 `111` + `101` + `101`, 转为八进制是 `7`+`5`+`5`，修改后的权限值为`111` + `111` + `100`，即`774`：
```shell
$ sudo chmod 774 apache
```
**符号模式**：   
符号模式`mode`参数有固定格式，`who operate permissions`   
`who` 代表权限组，有四种：
- `u` 属主权限
- `g` 属组权限
- `o` 其他用户权限
- `a` 以上所有   

`operate` 是对`who`的权限修改方式：
- `+` 增加权限
- `-` 去除权限
- `=` 赋权  

`permissions` 是权限值符号，即`rwx`符号  

采用符号模式修改权限，组增加写权限`g+w`，其他用户去掉执行权限`o-x`：
```shell
$ sudo chmod g+w apache
$ sudo chmod o-x apache
```
或者 
``` 
$ sudo chmod g=rwx apache
$ sudo chmod o=r-- apache
```

--- 

### 改变属主
`chown` 命令







